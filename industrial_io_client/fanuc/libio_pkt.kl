PROGRAM libio_pkt
--------------------------------------------------------------------------------
-- 
-- Library routines for creating / processing ROS-Industrial packets
-- 
-- Note: in its current state this library can only deserialise
--       IO Messages
-- 
-- TODO: handle other types of incoming messages properly.
-- 
-- 
-- author: Tim Hoffmann (Ruhrbotics)
-- 
--------------------------------------------------------------------------------
%NOLOCKGROUP
%NOPAUSE= COMMAND + TPENABLE + ERROR
%COMMENT = 'r1'





--------------------------------------------------------------------------------
-- 
-- local types & constants
-- 
--------------------------------------------------------------------------------
%INCLUDE include\libio_pkt_t



--VAR

--data_io_r_					:ARRAY[256] OF INTEGER	-- Array to check the read data
--data_io_w_				:ARRAY[256] OF INTEGER	-- Array to check the written data


--------------------------------------------------------------------------------
-- 
-- remote routine prototypes
-- 
--------------------------------------------------------------------------------




--------------------------------------------------------------------------------
-- 
-- local routine prototypes
-- 
--------------------------------------------------------------------------------
%INCLUDE include\libio_pkt_h
%INCLUDE include\libind_log_h


--------------------------------------------------------------------------------
-- 
-- Empty body
-- 
--------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

BEGIN
END libio_pkt

ROUTINE ipktio_d_srl	

VAR
	i__       					:INTEGER
	j__ 						:INTEGER
	stat__  		  			:INTEGER
	
	
	data_io_				:ARRAY[128] OF INTEGER-- Array IO Data 
	
	
	--------------------------------------------
	--Header
	length_				:INTEGER
	--------------------------------------------
	--Sub-Header
	message_id_		:INTEGER
	ctrlr_ft_mk_			:INTEGER	--ctrlr_feat_mask_
	timestamp_			:INTEGER
	num_items_			:INTEGER
  	--------------------------------------------
  	--Items
  	type_    				:ARRAY[16] OF INTEGER
  	start_     			:ARRAY[16] OF INTEGER
 	len_         			:ARRAY[16] OF INTEGER
  	feat_mask_   		:INTEGER
  	index_    			:INTEGER
 	result_   			:INTEGER
  	value_   				:INTEGER
  	

	
BEGIN
	i__					= 0
	j__ 					= 0
	stat__				= 0
	
	
	message_id_		= 0			
	ctrlr_ft_mk_			= 0					--ctrlr_feat_mask_
	timestamp_			= 0	
	num_items_			= 0	
  	feat_mask_   		= 0	
  	index_    			= 0	
 	result_   			= 0	
  	value_  				= 0	
	length_				= 0
	
	
	--set array data_jo_ null
  	FOR i__= 1 TO 128  DO
  	data_io_[i__]	= 0
  	ENDFOR
  	
	
	--
	--
	--read in fd file
	--
	--
	
	--
	--Read header into array
	
	--read length_ into the array data_io_
	READ fd(data_io_[1])
	stat__ = IO_STATUS(fd)
	IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
	--data_io_r_[1]=data_io_[1]	
	
	--read message type into array
	READ fd(data_io_[2])
	stat__ = IO_STATUS(fd)
	IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
	--data_io_r_[2]=data_io_[2]	
	
	--read comm type into array
	READ fd(data_io_[3])
	stat__ = IO_STATUS(fd)
	IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
	--data_io_r_[3]=data_io_[3]	
	
	--read reply type into array
	READ fd(data_io_[4])
	stat__ = IO_STATUS(fd)
	IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
	--data_io_r_[4]=data_io_[4]
	

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------				
		
		SELECT data_io_[2] OF 
		
			--
			--
			--
			-- IO_Info
			--
			--
			--
			
			CASE (RI_MT_IOINFO ) :
				
				--Header
				length_				=0
				
				--Sub-Header
				ctrlr_ft_mk_			=0--??
				num_items_			=2
				
				--Items 
				start_[1]				=0
				len_	[1]				=8
				feat_mask_			=0--??
				
				--
				--
				--fd FILE read in
				--
				--
				
				--
				--Sub-Header read in from the fd FILE
				--
				
				--read message_id_ into the array data_io_ from the fd FILE
				READ fd(data_io_[5])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
				--data_io_r_[5]=data_io_[5]	
				
				--
				--
				--description
				--
				--
				
				--
				--write header file
				--
				
				--predetermine length_
				data_io_[1]=6*4+num_items_*4*4 --(Header + Sub-Header) *4 +num_items_*(Items)*4
				
				--Write file length			
				WRITE fd(data_io_[1])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
				--data_io_w_[1]=data_io_[1]
				
				--Write message type
				WRITE fd(data_io_[2])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
				--data_io_w_[2]=data_io_[2]	
				
				--Write comm_type_ in  fd file
				WRITE fd(RI_CT_SVCRPL)--Not read, not in array
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
				--data_io_w_[3]=RI_CT_SVCRPL
				
				--write reply_type_ in fd file
				WRITE fd(RI_RT_SUCC)--Not read, not in array
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
				--data_io_w_[4]=RI_RT_SUCC
			
				--			
				--Write sub headers to fd File
				--
				
				--write message_id_in fd file   
				WRITE fd(data_io_[5])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
				--data_io_w_[5]=data_io_[5]
				
				--write ctrlr_feat_mask in fd file   
				WRITE fd(ctrlr_ft_mk_)
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
				--data_io_w_[6]=ctrlr_ft_mk_
				
				--write num_items_ in fd file   
				WRITE fd(num_items_)
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
				--data_io_w_[7]=num_items_
				
				--
				--Items in fd file write
				--				
				
				FOR i__ =0 TO (num_items_-1)  DO
					
					--Ermöglicht das senden von zwei verschieden type_
					IF i__ = 0 THEN type_[1] = io_rdi; ENDIF 
					IF i__ = 1 THEN type_[1] = io_rdo; ENDIF
											
					--write type_ in fd file
					WRITE fd(type_[1])									--Not read, not in array
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
					--data_io_w_[i__*4+8]=type_
					
					--write start_ in fd file
					WRITE fd(start_[1])									--Not read, not in array
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
					--data_io_w_[i__*4+9]=start_
					
					--write len_ in fd file
					WRITE fd(len_[1])										--Not read, not in array
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
					--data_io_w_[i__*4+10]=len_
					
					--write feat_mask_ in fd file
					WRITE fd(feat_mask_)								--Not read, not in array
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
					--data_io_w_[i__*4+11]=feat_mask_
					
				ENDFOR
				
				WRITE fd(CR)
					
				RETURN(1)	
			
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------				
			--
			--
			--
			-- IO_READ
			--
			--
			--
	
			
			CASE (RI_MT_IOREAD) : -- IO_READ

				--
				--
				--fd FILE Read
				--
				--
				
				
				--
				--read Sub-Header from FILE
				--
				
				--read message_id_  into the array data_io_ from the fd FILE
				READ fd(data_io_[5])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
--				data_io_r_[5]=data_io_[5]	
				
				
				--read num_items_ into the array data_io_ from the fd FILE
				READ fd(data_io_[7])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
--				data_io_r_[7]=data_io_[7]	
				
				--
				--check Buffer 
				--
				
				--ROUTINE  rpio_chkbuf(fd : FILE; msg_type_:INTEGER; num_items_ : INTEGER) : INTEGER FROM libio_pkt
				stat__ = rpio_chkbuf(fd, data_io_[2],data_io_[7])
				IF stat__ <> 0 THEN RETURN (-ABS(stat__)); ENDIF
				
				--
				--read Items from FILE
				--
				
				FOR i__ =0 TO (data_io_[7] -1)  DO -- from i to num_items_
					
					--read type_ into the array data_io_ from the fd FILE
					READ fd(data_io_[i__*4+8])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
--					data_io_r_[i__*4+8]=data_io_[i__*4+8]	
					
					--read index_ into the array data_io_ from the fd FILE
					READ fd(data_io_[i__*4+9])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
--					data_io_r_[i__*4+9]=data_io_[i__*4+9]	
				
					-- into the array data_io_ from the fd FILE
					--Reading out the digital and analog inputs
					--
				
					--GET_PORT_VAL(type_, index_, value_, result_)
					GET_PORT_VAL(data_io_[i__*4+8], data_io_[i__*4+9], data_io_[i__*4+11], data_io_[i__*4+10] )
					
					--Raise correct error code
					IF data_io_[i__*4+10] = 1 THEN data_io_[i__*4+10] = 2; 	
					ENDIF
					IF data_io_[i__*4+10] = 0 THEN data_io_[i__*4+10] = 1;
					ENDIF	
					
				
--					data_io_r_[i__*4+10]=data_io_[i__*4+10]	
--					data_io_r_[i__*4+11]=data_io_[i__*4+11]	
				
				
				ENDFOR	
				
				--
				--
				--fd FILE Description
				--
				--
					
				
				--
				--Write Header in fd file
				--
				
				--Predetermine length
				data_io_[1]=6*4+data_io_[7]*4*4 --(Header + Sub-Header) *4 +num_items_*(Items)*4
				
				--write length_ in fd file
				WRITE fd(data_io_[1])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
--				data_io_w_[1]=data_io_[1]
			
				--write msg_type_ in fd file
				WRITE fd(data_io_[2])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
--				data_io_w_[2]=data_io_[2]
				
				--write comm_type_ in fd file
				WRITE fd(RI_CT_SVCRPL) 
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
--				data_io_w_[3]=RI_CT_SVCRPL
				
				--write reply_type_ in fd file
				WRITE fd(RI_RT_SUCC)
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
--				data_io_w_[4]=RI_RT_SUCC
			
			
				--			
				--Sub-Header in fd file write
				--
				
				--write message_id_ in fd file   
				WRITE fd(data_io_[5])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
--				data_io_w_[5]=data_io_[5]
				
				--Determine time
				GET_TIME(data_io_[6])
				-- Only keep 16 bits: HH:MM:SS
				data_io_[6] = data_io_[6] AND 65535
				
				--write timestamp_ in fd file 
				WRITE fd( data_io_[6])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				
--				data_io_w_[6]=data_io_[6]
				
				--write num_items_in fd file   
				WRITE fd(data_io_[7])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF	
				
--				data_io_w_[7]=data_io_[7]
					
				--
				--Items in fd file write
				--
			
									
				FOR i__ = 0  TO (data_io_[7]-1)  DO -- for i to num_items_	
					
					--write type_ in fd file   
					WRITE fd(data_io_[i__*4+8])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
--					data_io_w_[i__*4+8]=data_io_[i__*4+8]
					
					--write index_ in fd file   
					WRITE fd(data_io_[i__*4+9])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
--					data_io_w_[i__*4+9]=data_io_[i__*4+9]
					
					--write result_ in fd file   
					WRITE fd(data_io_[i__*4+10])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
--					data_io_w_[i__*4+10]=data_io_[i__*4+10]
					
					--write value_ in fd file   
					WRITE fd(data_io_[i__*4+11])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
--					data_io_w_[i__*4+11]=data_io_[i__*4+11]
					
				ENDFOR	
				
				WRITE fd(CR)

					
				RETURN(1)	
			
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------		
			--
			--
			--
			-- IO_WRITE
			--
			--
			--
			
			CASE (RI_MT_IOWRIT) : -- IO_WRITE
				--
				--read Sub-Header from fd FILE 
				--
				
				--read message_id_  into the array data_io_ from the fd FILE
				READ fd(data_io_[5])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_r_[5]=data_io_[5]	
				
				--read num_items_ into the array data_io_ from the fd FILE
				READ fd(data_io_[7])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_r_[7]=data_io_[7]	
				
				--
				--Buffer check
				--
				
				--ROUTINE  rpio_chkbuf(fd : FILE; msg_type_:INTEGER; num_items_ : INTEGER) : INTEGER FROM libio_pkt
				stat__= rpio_chkbuf(fd, data_io_[2],data_io_[7])
				IF stat__ <> 0 THEN RETURN (-ABS(stat__)); ENDIF
				
				--
				--read Items from fd FILE
				--
				

				FOR i__ =0 TO (data_io_[7]-1)  DO  -- from i to num_items_
					
					--read type_ into the array data_io_ from the fd FILE
					READ fd(data_io_[i__*4+8])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					--data_io_r_[i__*4+8]=data_io_[i__*4+8]	
					
					--read index_  into the array data_io_ from the fd FILE
					READ fd(data_io_[i__*4+9])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					--data_io_r_[i__*3+9]=data_io_[i__*4+9]	
					
					--read value_ from fd FILE
					READ fd(value_)
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					--data_io_r_[i__*4+10]=value_	
					
					
					--
					--write the digital and analog outputs
					--
					
					-- SET_PORT_VAL(type_, index_, value_, result_)
					SET_PORT_VAL(data_io_[i__*4+8], data_io_[i__*4+9], value_,data_io_[i__*4+11])
					
					--Set correct error code
					IF data_io_[i__*4+11] = 1 THEN data_io_[i__*4+11] = 2; 	
					ENDIF
					IF data_io_[i__*4+11] = 0 THEN data_io_[i__*4+11] = 1;
					ENDIF	
				ENDFOR
					
				--
				--write Header in fd file
				--
				
				--Determine length
				data_io_[1]=6*4+data_io_[7]*3*4 --(Header + Sub-Header) *4 +num_items_*(Items)*4
				
				--write length_ in fd file
				WRITE fd(data_io_[1])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[1]=data_io_[1]
				
				--write msg_type_ in fd file
				WRITE fd(data_io_[2])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[2]=data_io_[2]


				--write comm_type_ in fd file
				WRITE fd(RI_CT_SVCRPL)
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[3]=RI_CT_SVCRPL
				
				--write reply_type_ in fd file
				WRITE fd(RI_RT_SUCC)
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[4]=RI_RT_SUCC
			
				--			
				--Sub-Header in fd file write
				--
				
				
				--write message_id_ in fd file 
				WRITE fd(data_io_[5])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[5]=data_io_[5]
				
				--determine the time
				GET_TIME(data_io_[6])
				-- keep the lower 16 bits: HH:MM:SS
				data_io_[6] = data_io_[6] AND 65535
				
				--write timestamp_ in fd file 
				WRITE fd(data_io_[6])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[6]=data_io_[6]
				
				--write num_items_ in fd file
				WRITE fd(data_io_[7])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[7]=data_io_[7]
			
				
				FOR i__ = 0 TO (data_io_[7]-1)  DO  -- for i to num_items_

					
					--write type_ in fd file
					WRITE fd(data_io_[i__*4+8])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					--data_io_w_[i__*4+8]=data_io_[i__*4+8]
					
					---write index_ in fd file
					WRITE fd(data_io_[i__*4+9])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					--data_io_w_[i__*4+9]=data_io_[i__*4+9]
					
					--write result_ in fd file  
					WRITE fd(data_io_[i__*4+11])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					--data_io_w_[i__*4+11]=data_io_[i__*4+11]
					
				ENDFOR
				
				--WRITE fd(CR)
					
				RETURN(1)		
		
		
		
			
			--
			--
			--
			-- IO_STREAM_SUB
			--
			--
			--
			
			CASE (RI_MT_IOSTSB) : -- IO_STREAM_SUB
			--WRITE TPDISPLAY('Ich war in IO_STREAM_SUB',CR)

				--read message_id into the array data_io_ (unused)
				READ fd(data_io_[5])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_r_[5]=data_io_[5]

				--read num_items into the array data_io_ (unused)
				READ fd(num_items_)
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_r_[6]=num_items_
				
				FOR i__ = 1 TO num_items_ DO
					READ fd(type_[i__])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					--data_io_r_[7+ 3*(i__-1)]=type_[i__]
					
					READ fd(start_[i__])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					--data_io_r_[8+ 3*(i__-1)]=start_[i__]

					READ fd(len_[i__])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					--data_io_r_[9+ 3*(i__-1)]=len_[i__]
				ENDFOR
				
				-- calculate output length
				data_io_[1] = 5*4  -- hdr + sub_hdr
				FOR i__ = 1 TO num_items_ DO
					data_io_[1] = data_io_[1] + (3+len_[i__])*4
				ENDFOR

				--write length_ in fd file
				WRITE fd(data_io_[1])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[1]=data_io_[1]
				
				--write msg_type_ in fd file
				WRITE fd(RI_MT_IOSTPB)
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[2]=RI_MT_IOSTPB
				
				--write comm_type_ in fd file
				WRITE fd(RI_CT_TOPIC)
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[3]=RI_CT_TOPIC

				--write reply_type_ in fd file
				WRITE fd(RI_RT_INVAL)
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[4]=RI_RT_INVAL
			
				--			
				--Sub-Header in fd file write
				--
				
				--determine the time
				GET_TIME(data_io_[5])
				-- behält nur die unteren16 bits: HH:MM:SS
				data_io_[5] = data_io_[5] AND 65535
				
				--write timestamp_ in fd file 
				WRITE fd(data_io_[5])
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[5]=data_io_[5]
				
				--write num_items_ in fd file  
				WRITE fd(num_items_)
				stat__ = IO_STATUS(fd)
				IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
				--data_io_w_[6]=num_items_
				
				
				--
				--Items in fd file write
				--
		
				FOR i__= 1 TO num_items_  DO
					
					--write type_ in fd file
					WRITE fd(type_[i__])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
					--write start_ in fd file
					WRITE fd(start_[i__])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
					--write len_ in fd file
					WRITE fd(len_[i__])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF

					--
					--Values in fd file write
					--
					
					--Determine start_ and len_
					FOR j__ = start_[i__] TO start_[i__]+len_[i__]-1  DO	
						--
						--Reading out the digital and analog inputs
						--
					
						--GET_PORT_VAL(type_, index_, value_, result_)
						GET_PORT_VAL(type_[i__], j__, value_, result_ )
					
						--write value_ in fd file 
						WRITE fd(value_)									--Not read, not in array
						stat__ = IO_STATUS(fd)
						IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					ENDFOR
				
				ENDFOR
				
		
		ELSE:
		
			IF data_io_[3] = RI_CT_SVCREQ THEN  	
				
					-- still change
                    -- predetermine the length_
					data_io_[1]=3*4 --(Header ) *4 
					
					--write length_ in fd file
					WRITE fd(data_io_[1])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
							
					--write msg_type_ in fd file
					WRITE fd(data_io_[2])
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
	--				data_io_w_[2]=data_io_[2]	
					
					--write comm_type_ in fd file
					WRITE fd(RI_CT_SVCRPL)--Not read, not in array
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
	--				data_io_w_[3]=RI_CT_SVCRPL
					
					--write reply_type_ in fd file
					WRITE fd(RI_RT_FAIL)--Not read, not in array
					stat__ = IO_STATUS(fd)
					IF stat__ <> 0 THEN RETURN (-stat__); ENDIF
					
					WRITE fd(CR)
				
			ENDIF
			
			
		
				
		ENDSELECT	
		
		RETURN(1)
	
		
		--TODO
		--Catch error for no case
		
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------		


	
END  ipktio_d_srl	

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

ROUTINE  rpio_chkbuf
VAR
	stat__				:INTEGER
	bytes_ahd__			:INTEGER
	size__				:INTEGER
BEGIN

	bytes_ahd__		=0
	stat__			=0
	size__			=0	--Array size request		

	

	
	SELECT msg_type_ OF 
					
			CASE (RI_MT_IOINFO ) :
			
			--We don't need it because we don't read any items
			
			CASE (RI_MT_IOREAD ) :
			
			size__=num_items_*8 -- num_items_*(type_+index_)	 type_, index_ : uint32/integer 
			
			CASE (RI_MT_IOWRIT ) :
			
			size__=num_items_*12-- num_items_*(type_+index_+value_)	 type_, value_, index_ : uint32/integer
	
			CASE (RI_MT_IOSTSB ) :
			
			--We don't need it because we don't read any items
	
	ENDSELECT
	
			
	-- check nr of bytes in buffer
	BYTES_AHEAD(fd, bytes_ahd__, stat__)
	
	IF stat__ <> 0 THEN RETURN (-stat__); ENDIF

	-- is there enough for a packet?
	
	--it is enough if the size is as large as the buffer?
	
		
	IF (bytes_ahd__ < (size__)) THEN
		RETURN (1)
	ENDIF
	
	-- done
	RETURN (-ABS(stat__))


END rpio_chkbuf
	

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------